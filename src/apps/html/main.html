<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Guides</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v3.5.1/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.5.1/mapbox-gl.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
    #map {
        position: absolute;
        top: 0;
        bottom: 5%;
        width: 75%;
        z-index: 1; /* 지도의 z-index 명확하게 설정 */
    }

    #right-info-background {
        position: absolute;
        top: 0;
        bottom: 5%;
        right: 0;
        width: 25%; /* 남은 25%를 차지하는 배경 설정 */
        background-color: rgba(0, 0, 0, 0.8); /* 어두운 배경색 */
        z-index: 1; /* 그래프와 동일한 z-index 설정 */
    }

    /* 아래쪽 검정색 바 */
    #bottom-info-background {
        position: absolute;
        bottom: 0;
        height: 5%; /* 전체 높이의 5%를 차지하는 검정 바 */
        width: 100%;
        background-color: rgba(0, 0, 0, 0.8); /* 어두운 배경색 */
        z-index: 1;
    }

    #weather-info {
        position: absolute;
        top: 60px;
        left: 10px;
        background-color: rgba(0, 0, 0, 0.7); /* 약간 투명한 검은색 배경 */
        padding: 15px; /* 충분한 여백 */
        border-radius: 10px; /* 부드러운 모서리 */
        font-family: Arial, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        z-index: 2;
        width: 180px; /* 일정한 너비 */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); /* 약간의 그림자 효과 */
    }

    #weather-icon {
        width: 80px; /* 아이콘 크기 조정 */
        height: 80px;
        margin-bottom: 10px;
    }

    #location, #temperature, #humidity {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 5px;
        text-align: center; /* 텍스트 가운데 정렬 */
        color: white; /* 텍스트 색상을 흰색으로 설정 */
    }

    /* 그래프 컨테이너 스타일 */
    #graphs {
        position: absolute;
        top: 100px;
        bottom: 5%;
        right: 0px;
        width: 23%; /* 더 좁은 너비로 설정하여 맵과 겹치지 않도록 함 */
        background-color: rgba(0, 0, 0, 0.7); /* 동일한 어두운 배경 */
        padding: 15px; /* 내부 여백 추가 */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); /* 그림자 효과 */
        display: flex;
        flex-direction: column;
        z-index: 2; /* 맵 위에 그래프가 보이도록 설정 */
    }

    /* 개별 그래프 스타일 */
    .graph {
        flex: 1;
        position: relative;
        margin-top: 30px; /* 그래프 간 간격 조정 */
        margin-left: 10px; /* 왼쪽 여백 추가하여 맵과 겹치지 않도록 설정 */
        background-color: rgba(0, 0, 0, 0.7); /* 동일한 배경색 */
        padding: 10px;
        border-radius: 10px; /* 둥근 모서리 */
    }

    /* PDR 상태 정보 스타일 */
    #pdr-status {
        position: absolute;
        top: 0;
        right: 10px;
        background-color: rgba(0, 0, 0, 0.8); /* 약간 투명한 검은색 배경 */
        padding: 10px 20px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        font-family: 'Arial', sans-serif;
        font-size: 20px;
        color: white;
        z-index: 2;
        text-align: center;
    }

    /* Latency 상태 정보 스타일 */
    #latency-status {
        position: absolute;
        top: 50px; /* PDR 상태 정보 아래 */
        right: 10px;
        background-color: rgba(0, 0, 0, 0.8); /* 약간 투명한 검은색 배경 */
        padding: 10px 20px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        font-family: 'Arial', sans-serif;
        font-size: 20px;
        color: white;
        z-index: 2;
        text-align: center;
    }

    #pdr-value {
        color: #32CD32; /* PDR 문구의 초록색 */
        font-weight: bold;
    }

    #latency-value {
        color: #1E90FF; /* Latency 문구의 파란색 */
        font-weight: bold;
    }

    /* 버튼 스타일 */
    #center-button, #centerToggleButton, #lineToggleButton {
        position: absolute;
        padding: 10px 20px;
        background-color: rgba(0, 0, 0, 0.7); /* 약간 투명한 검은색 배경 */
        border: none;
        border-radius: 10px; /* 부드러운 모서리 */
        color: white; /* 흰색 텍스트 */
        cursor: pointer;
        font-size: 16px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); /* 그림자 효과 */
        z-index: 3; /* 버튼들의 z-index를 높여서 모달 창 뒤에 숨지 않도록 설정 */
    }

    #center-button {
        top: 10px;
        left: 10px;
    }

    #centerToggleButton {
        top: 10px;
        left: 220px;
    }

    #lineToggleButton {
        top: 10px;
        left: 395px;
    }

    #center-button:hover, #centerToggleButton:hover, #lineToggleButton:hover {
        background-color: rgba(0, 0, 0, 0.8); /* 마우스를 올렸을 때 더 어두운 배경 */
    }

    #traffic-light {
        position: absolute;
        top: 290px;
        left: 10px;
        z-index: 10;
        text-align: center;
        padding: 5px;
        border-radius: 5px;
        background-color: rgba(0, 0, 0, 0.8);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); /* 그림자 효과 */
    }
    #traffic-light img {
        width: 110px;
        height: auto;
    }
    #traffic-light-status {
        font-size: 30px;
        margin-top: 5px;
        font-weight: bold;
    }
    /* 모달 배경 */
    #modal-background {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
    }
    /* 모달 창 */
    #modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 400px; /* 모달 너비 */
        padding: 30px; /* 충분한 패딩 */
        background-color: white;
        border-radius: 10px; /* 부드러운 모서리 */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* 그림자 효과 */
        z-index: 1001;
        text-align: center;
        font-family: Arial, sans-serif;
    }
    /* 입력 필드 */
    .modal-input {
        width: calc(100% - 20px); /* 입력 필드 너비 조정 */
        padding: 10px;
        margin: 10px 0;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 5px;
    }
    /* 모달 버튼 스타일 */
    .modal-button {
        padding: 10px 20px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
    }
    .modal-button:hover {
        background-color: #45a049; /* 마우스를 올릴 때 색상 변경 */
    }

    #ci-logo {
        position: absolute;
        bottom: 0;  /* 맨 아래에서 5% 위로 띄워줍니다 (검정색 바 바로 위) */
        left: 10px;  /* 왼쪽에 고정 */
        z-index: 2;  /* 다른 요소들보다 위에 배치 */
        padding: 5px; /* 여백 추가 */
    }

    #ci-logo img {
        width: 270px;  /* CI 이미지의 너비를 적절한 크기로 조정 */
        height: auto;
    }

</style>
</head>
<body>
<div id="map"></div>
<div id="right-info-background"></div>
<div id="bottom-info-background"></div>

<div id="weather-info">
    <img id="weather-icon" src="" alt="Weather Icon"/>
    <div id="location">Location: --</div>
    <div id="temperature">Temperature: --°C</div>
    <div id="humidity">Humidity: --%</div>
</div>

<div id="pdr-status">
    <span id="pdr-value">PDR (Packet Delivery Rate): --</span>
</div>
<div id="latency-status">
    <span id="latency-value">Latency (Air to Air): --</span>
</div>

<div id="graphs">
    <div id="graph1" class="graph"></div>
    <div id="graph2" class="graph"></div>
</div>

<div id="traffic-light">
    <img id="traffic-light-image" src="https://raw.githubusercontent.com/KETI-A/athena/main/src/apps/html/images/red-light.png" alt="Traffic Light" width="50">
    <p id="traffic-light-status" style="color: red;">RED Light<br>(STOP)</p>
</div>

<button id="center-button">Center on Coordinates</button>
<button id="centerToggleButton">Enable Centering</button>
<button id="lineToggleButton">Enable Connected Vehicle</button>

<!-- 모달 배경 -->
<div id="modal-background"></div>

<!-- 모달 창 -->
<div id="modal">
    <h2>테스트 모드를 선택하세요</h2>
    <label for="testType">Tx 또는 Rx를 입력하세요:</label><br>
    <input type="text" id="testType" class="modal-input" placeholder="Tx 또는 Rx"><br>
    <label for="ipAddress">IP 주소를 입력하세요:</label><br>
    <input type="text" id="ipAddress" class="modal-input" placeholder="기본값: 10.252.110.58"><br>
    <button id="submit-button" class="modal-button">확인</button>
</div>

<div id="ci-logo">
    <img src="https://raw.githubusercontent.com/KETI-A/athena/main/src/apps/html/images/keti_ci.png" alt="CI Logo">
</div>

<script>
window.onload = function() {
    // 모달 창 열기
    document.getElementById('modal-background').style.display = 'block';
    document.getElementById('modal').style.display = 'block';

    // 기본값 설정
    let defaultIpAddress = "10.252.110.58";

    // 버튼 클릭 이벤트 처리
    document.getElementById('submit-button').onclick = function() {
        // 사용자 입력 값 가져오기
        let testType = document.getElementById('testType').value.toLowerCase();
        let ipAddress = document.getElementById('ipAddress').value || defaultIpAddress;

        // 테스트 모드 확인 및 설정
        let testMode;
        let isTxTest;
        if (testType === "tx") {
            testMode = "Tx Test";
            isTxTest = true;
        } else if (testType === "rx") {
            testMode = "Rx Test";
            isTxTest = false;
        } else {
            alert("잘못된 입력입니다. 기본적으로 Tx Test 모드가 선택됩니다.");
            testMode = "Tx Test";
            isTxTest = true;
        }

        // 모달 닫기
        document.getElementById('modal-background').style.display = 'none';
        document.getElementById('modal').style.display = 'none';

        // alert 창으로 현재 테스트 모드와 IP 주소를 출력
        alert(`현재 선택된 테스트 모드: ${testMode}\n입력된 IP 주소: ${ipAddress}`);

        // 버튼이 제대로 표시되도록 모달 창이 닫힌 후 버튼을 다시 표시
        document.getElementById('center-button').style.display = 'block';
        document.getElementById('centerToggleButton').style.display = 'block';
        document.getElementById('lineToggleButton').style.display = 'block';

        // 입력이 완료된 후 메인 로직 실행
        main(isTxTest, ipAddress);
    };

    function main(isTxTest, ipAddress) {
        // KETI Pangyo
        const cKetiPangyoLatitude = 37.4064;
        const cKetiPangyolongitude = 127.1021;

        // RSU Location
        const cPangyoRsuLatitude16 = 37.409221;
        const cPangyoRsuLongitude16 = 127.099505;

        const cPangyoRsuLatitude17 = 37.406536;
        const cPangyoRsuLongitude17 = 127.100765;

        const cPangyoRsuLatitude18 = 37.405254;
        const cPangyoRsuLongitude18 = 127.103609;

        const cPangyoRsuLatitude5 = 37.410922;
        const cPangyoRsuLongitude5 = 127.094732;

        const cPangyoRsuLatitude31 = 37.411751;
        const cPangyoRsuLongitude31 = 127.095019;

        var vehicleLatitude0 = 37.4062;
        var vehicleLongitude0 = 127.1032;

        var vehicleLatitude1 = 37.4058;
        var vehicleLongitude1 = 127.1035;

        var vehicleHeading0 = 320;
        var vehicleHeading1 = 320;

        let s_nRxLatitude, s_nRxLongitude, s_unRxVehicleHeading;
        let s_nTxLatitude, s_nTxLongitude, s_unTxVehicleHeading;
        let s_unPdr, s_ulLatencyL1, s_ulTotalPacketCnt, s_unSeqNum;

        let s_unTempTxCnt = 0;
        let isCenteringEnabled = false;
        let isCvLineEnabled = false;

        mapboxgl.accessToken = 'pk.eyJ1IjoieWVzYm1hbiIsImEiOiJjbHoxNHVydHQyNzBzMmpzMHNobGUxNnZ6In0.bAFH10On30d_Cj-zTMi53Q';
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/yesbman/clyzkeh8900dr01pxdqow8awk',
            projection: 'globe',
            zoom: 19,
            center: [cKetiPangyolongitude, cKetiPangyoLatitude]
        });

        map.addControl(new mapboxgl.NavigationControl());

        map.on('style.load', () => {
            map.setFog({});

            document.getElementById('center-button').addEventListener('click', function() {
                map.setCenter([s_nRxLongitude, s_nRxLatitude]);
            });
        });

        document.getElementById('centerToggleButton').addEventListener('click', function() {
            isCenteringEnabled = !isCenteringEnabled;
            this.textContent = isCenteringEnabled ? 'Disable Centering' : 'Enable Centering';
        });

        document.getElementById('lineToggleButton').addEventListener('click', function() {
            isCvLineEnabled = !isCvLineEnabled;
            this.textContent = isCvLineEnabled ? 'Disable Connected Vehicle' : 'Enable Connected Vehicle';
        });

        if ('WebSocket' in window) {
            let ws = new WebSocket(`ws://${ipAddress}:3001/websocket`);
            ws.onopen = () => {
                console.log('WebSocket connection established');
                ws.send('Client connected');
            }

            function reverseHeading(heading) {
                // heading 값을 180도 회전시키고 좌우를 반대로 변환
                let reversedHeading = (360 - ((parseInt(heading) + 180) % 360)) % 360;
                return reversedHeading;
            }

            if(isTxTest) {
                ws.onmessage = (message) => {
                    let data = message.data.split(',');
                    s_nRxLatitude = data[23]; // Mine
                    s_nRxLongitude = data[24]; // Mine
                    s_unRxVehicleHeading = reverseHeading(data[29]); // 변환된 heading 값
                    s_nTxLatitude = vehicleLatitude1;
                    s_nTxLongitude = vehicleLongitude1;
                    s_unTxVehicleHeading = vehicleHeading1;
                    s_unPdr = 100;
                    s_ulLatencyL1 = 500;
                    s_ulTotalPacketCnt = 1 + s_unTempTxCnt;
                    s_unSeqNum = 1 + s_unTempTxCnt;

                    s_unTempTxCnt += 1;
                }
            }
            else
            {
                ws.onmessage = (message) => {
                    let data = message.data.split(',');
                    s_nRxLatitude = data[62];
                    s_nRxLongitude = data[63];
                    s_unRxVehicleHeading = reverseHeading(data[56]);
                    s_nTxLatitude = data[32];
                    s_nTxLongitude = data[33];
                    s_unTxVehicleHeading = reverseHeading(data[38]);
                    s_unPdr = data[68];
                    s_ulLatencyL1 = data[43];
                    s_ulTotalPacketCnt = data[66];
                    s_unSeqNum = data[35];
                }
            }

            ws.onerror = (error) => {
                console.error('WebSocket error', error);
            }

            ws.onclose = () => {
                console.log('WebSocket connection closed');
            }
        } else {
            console.error('WebSocket is not supported by this browser');
        }

        map.on('load', () => {

            map.on('zoom', () => {
                map.resize();  // 확대/축소 시 강제로 지도를 리렌더링
            });

            map.on('move', () => {
                map.resize();  // 지도가 이동될 때 리렌더링
            });

            map.loadImage(
                'https://raw.githubusercontent.com/KETI-A/athena/main/src/apps/html/images/keti_ci.png',
                (error, image) => {
                    if (error) throw error;

                    map.addImage('keti-log', image);

                    map.addSource('keti_log_src', {
                        'type': 'geojson',
                        'data': {
                            'type': 'FeatureCollection',
                            'features': [
                                {
                                    'type': 'Feature',
                                    'geometry': {
                                        'type': 'Point',
                                        'coordinates': [cKetiPangyolongitude, cKetiPangyoLatitude]
                                    }
                                }
                            ]
                        }
                    });

                    map.addLayer({
                        'id': 'keti',
                        'type': 'symbol',
                        'source': 'keti_log_src',
                        'layout': {
                            'icon-image': 'keti-log',
                            'icon-size': 0.50
                        }
                    });
                }
            );

            map.loadImage(
                'https://raw.githubusercontent.com/KETI-A/athena/main/src/apps/html/images/fixed-rsu.png',
                (error, image) => {
                    if (error) throw error;

                    map.addImage('rsu', image);

                    map.addSource('rsu-src-18', {
                        'type': 'geojson',
                        'data': {
                            'type': 'FeatureCollection',
                            'features': [
                                {
                                    'type': 'Feature',
                                    'geometry': {
                                        'type': 'Point',
                                        'coordinates': [cPangyoRsuLongitude18, cPangyoRsuLatitude18]
                                    }
                                }
                            ]
                        }
                    });

                    map.addLayer({
                        'id': 'rsu18',
                        'type': 'symbol',
                        'source': 'rsu-src-18',
                        'layout': {
                            'icon-image': 'rsu',
                            'icon-size': 0.5
                        }
                    });

                    map.addSource('rsu-src-16', {
                        'type': 'geojson',
                        'data': {
                            'type': 'FeatureCollection',
                            'features': [
                                {
                                    'type': 'Feature',
                                    'geometry': {
                                        'type': 'Point',
                                        'coordinates': [cPangyoRsuLongitude16, cPangyoRsuLatitude16]
                                    }
                                }
                            ]
                        }
                    });

                    map.addLayer({
                        'id': 'rsu16',
                        'type': 'symbol',
                        'source': 'rsu-src-16',
                        'layout': {
                            'icon-image': 'rsu',
                            'icon-size': 0.5
                        }
                    });

                    map.addSource('rsu-src-17', {
                        'type': 'geojson',
                        'data': {
                            'type': 'FeatureCollection',
                            'features': [
                                {
                                    'type': 'Feature',
                                    'geometry': {
                                        'type': 'Point',
                                        'coordinates': [cPangyoRsuLongitude17, cPangyoRsuLatitude17]
                                    }
                                }
                            ]
                        }
                    });

                    map.addLayer({
                        'id': 'rsu17',
                        'type': 'symbol',
                        'source': 'rsu-src-17',
                        'layout': {
                            'icon-image': 'rsu',
                            'icon-size': 0.5
                        }
                    });

                }
            );

            map.addSource('rsu-src-31', {
                'type': 'geojson',
                'data': {
                    'type': 'FeatureCollection',
                    'features': [
                        {
                            'type': 'Feature',
                            'geometry': {
                                'type': 'Point',
                                'coordinates': [cPangyoRsuLongitude31, cPangyoRsuLatitude31]
                            }
                        }
                    ]
                }
            });

            map.addLayer({
                'id': 'rsu31',
                'type': 'symbol',
                'source': 'rsu-src-31',
                'layout': {
                    'icon-image': 'rsu',
                    'icon-size': 0.5
                }
            });

            map.addSource('rsu-src-5', {
                'type': 'geojson',
                'data': {
                    'type': 'FeatureCollection',
                    'features': [
                        {
                            'type': 'Feature',
                            'geometry': {
                                'type': 'Point',
                                'coordinates': [cPangyoRsuLongitude5, cPangyoRsuLatitude5]
                            }
                        }
                    ]
                }
            });

            map.addLayer({
                'id': 'rsu5',
                'type': 'symbol',
                'source': 'rsu-src-5',
                'layout': {
                    'icon-image': 'rsu',
                    'icon-size': 0.5
                }
            });
        });

        map.loadImage(
            'https://raw.githubusercontent.com/KETI-A/athena/main/src/apps/html/images/ioniq5.png',
            (error, image) => {
                if (error) throw error;

                map.addImage('vehicle', image);

                map.addSource('vehicle_src_0', {
                    'type': 'geojson',
                    'data': {
                        'type': 'FeatureCollection',
                        'features': [
                            {
                                'type': 'Feature',
                                'geometry': {
                                    'type': 'Point',
                                    'coordinates': [vehicleLongitude0, vehicleLatitude0]
                                }
                            }
                        ]
                    }
                });

                map.addLayer({
                    'id': 'vehicle0',
                    'type': 'symbol',
                    'source': 'vehicle_src_0',
                    'layout': {
                        'icon-image': 'vehicle',
                        'icon-size': 0.2,
                        'icon-rotate': ['get', 'heading'],
                        'text-field': ['concat', 'Heading ', ['get', 'heading']],
                        'text-font': ['Open Sans Semibold', 'Arial Unicode MS Bold'],
                        'text-offset': [0, 1.25], // Adjust this value to position the text
                        'text-anchor': 'top'
                    },
                    'paint': {
                        'text-color': '#000000',
                        'text-halo-color': '#FFFFFF',
                        'text-halo-width': 2
                    }
                });
            }
        );

        map.loadImage(
            'https://raw.githubusercontent.com/KETI-A/athena/main/src/apps/html/images/ioniq-electric.png',
            (error, image) => {
                if (error) throw error;

                map.addImage('vehicle1', image);

                map.addSource('vehicle_src_1', {
                    'type': 'geojson',
                    'data': {
                        'type': 'FeatureCollection',
                        'features': [
                            {
                                'type': 'Feature',
                                'geometry': {
                                    'type': 'Point',
                                    'coordinates': [vehicleLongitude1, vehicleLatitude1]
                                }
                            }
                        ]
                    }
                });

                map.addSource('line', {
                    'type': 'geojson',
                    'data': {
                        'type': 'Feature',
                        'geometry': {
                            'type': 'LineString',
                            'coordinates': [[vehicleLongitude0, vehicleLatitude0], [vehicleLongitude1, vehicleLatitude1]]
                        }
                    }
                });

                map.addLayer({
                    'id': 'lineLayer',
                    'type': 'line',
                    'source': 'line',
                    'layout': {},
                    'paint': {
                        'line-color': [
                            'interpolate',
                            ['linear'],
                            ['line-progress'],
                            0, '#00FFFF',
                            1, '#008B8B'
                        ],
                        'line-width': 1.5
                    }
                });

                map.addLayer({
                    'id': 'lineLabelLayer',
                    'type': 'symbol',
                    'source': 'line',
                    'layout': {
                        'symbol-placement': 'line',
                        'text-field': 'Connected V2X',
                        'text-font': ['Open Sans Regular', 'Arial Unicode MS Regular'],
                        'text-size': 12,
                        'text-anchor': 'center'
                    },
                    'paint': {
                        'text-color': '#000000',
                        'text-halo-color': '#FFFFFF',
                        'text-halo-width': 2
                    }
                });

                map.addLayer({
                    'id': 'vehicle1',
                    'type': 'symbol',
                    'source': 'vehicle_src_1',
                    'layout': {
                        'icon-image': 'vehicle1',
                        'icon-size': 0.2,
                        'icon-rotate': ['get', 'heading'],
                        'text-field': ['concat', 'Heading ', ['get', 'heading']],
                        'text-font': ['Open Sans Semibold', 'Arial Unicode MS Bold'],
                        'text-offset': [0, 1.25], // Adjust this value to position the text
                        'text-anchor': 'top'
                    },
                    'paint': {
                        'text-color': '#000000',
                        'text-halo-color': '#FFFFFF',
                        'text-halo-width': 2
                    }
                });
            }
        );

        function updateVehiclePosition(vehicleId, coordinates, heading) {
            map.getSource(`vehicle_src_${vehicleId}`).setData({
                'type': 'FeatureCollection',
                'features': [{
                    'type': 'Feature',
                    'geometry': {
                        'type': 'Point',
                        'coordinates': coordinates
                    },
                    'properties': {
                        'heading': heading
                    }
                }]
            });

            if (vehicleId === 0) {
                vehicleLongitude0 = coordinates[0];
                vehicleLatitude0 = coordinates[1];
            } else if (vehicleId === 1) {
                vehicleLongitude1 = coordinates[0];
                vehicleLatitude1 = coordinates[1];
            }

            if (isCvLineEnabled)
            {
            map.getSource('line').setData({
                'type': 'Feature',
                'geometry': {
                    'type': 'LineString',
                    'coordinates': [[vehicleLongitude0, vehicleLatitude0], [vehicleLongitude1, vehicleLatitude1]]
                }
            });
            }

            if (isCenteringEnabled && vehicleId === 0) {
                map.setCenter(coordinates);
            }

            //map.setBearing(heading);
        }

        function updateTrafficLightBasedOnHeading(heading) {
            const trafficLightImage = document.getElementById('traffic-light-image');
            const trafficLightStatus = document.getElementById('traffic-light-status');

            if (heading >= 0 && heading <= 90) {
                trafficLightImage.src = 'https://raw.githubusercontent.com/KETI-A/athena/main/src/apps/html/images/green-light.png';  // 초록 불로 변경
                trafficLightStatus.innerHTML = 'Green Light<br>(GO)';       // 텍스트 업데이트
                trafficLightStatus.style.color = 'green';
            } else if (heading >= 91 && heading <= 180) {
                trafficLightImage.src = 'https://raw.githubusercontent.com/KETI-A/athena/main/src/apps/html/images/yellow-light.png';  // 주황 불로 변경
                trafficLightStatus.innerHTML = 'Yellow Light<br>(SLOW)';      // 텍스트 업데이트
                trafficLightStatus.style.color = 'orange';
            } else if (heading >= 181 && heading <= 359) {
                trafficLightImage.src = 'https://raw.githubusercontent.com/KETI-A/athena/main/src/apps/html/images/red-light.png';  // 빨간 불로 변경
                trafficLightStatus.innerHTML = 'RED Light<br>(STOP)';         // 텍스트 업데이트
                trafficLightStatus.style.color = 'red';
            }
        }

        function fetchAndUpdate() {
            const latitude0 = parseFloat(s_nRxLatitude);
            const longitude0 = parseFloat(s_nRxLongitude);
            const heading0 = parseFloat(s_unRxVehicleHeading);
            const latitude1 = parseFloat(s_nTxLatitude);
            const longitude1 = parseFloat(s_nTxLongitude);
            const heading1 = parseFloat(s_unTxVehicleHeading);

            if (!isNaN(latitude0) && !isNaN(longitude0)) {
                updateVehiclePosition(0, [longitude0, latitude0], heading0);
                updateTrafficLightBasedOnHeading(heading0);  // 신호등 업데이트
            }

            if (!isNaN(latitude1) && !isNaN(longitude1)) {
                updateVehiclePosition(1, [longitude1, latitude1], heading1);
            }
        }

        fetchAndUpdate();
        setInterval(fetchAndUpdate, 10);

        function fetchAndUpdateGraph() {
            const latitude0 = parseFloat(s_nRxLatitude);
            const longitude0 = parseFloat(s_nRxLongitude);
            const heading0 = parseFloat(s_unRxVehicleHeading);
            const latitude1 = parseFloat(s_nTxLatitude);
            const longitude1 = parseFloat(s_nTxLongitude);
            const heading1 = parseFloat(s_unTxVehicleHeading);
            const unPdr = parseFloat(s_unPdr);
            const ulLatencyL1 = parseFloat(s_ulLatencyL1);
            const ulTotalPacketCnt = parseFloat(s_ulTotalPacketCnt);
            const unSeqNum = parseFloat(s_unSeqNum);

            /*
            console.log(`latitude0: ${latitude0}`);
            console.log(`longitude0: ${longitude0}`);
            console.log(`heading0: ${heading0}`);
            console.log(`latitude1: ${latitude1}`);
            console.log(`longitude1: ${longitude1}`);
            console.log(`heading1: ${heading1}`);
            console.log(`unPdr: ${unPdr}`);
            console.log(`ulLatencyL1: ${ulLatencyL1}`);
            console.log(`ulTotalPacketCnt: ${ulTotalPacketCnt}`);
            console.log(`unSeqNum: ${unSeqNum}`);
            */

            if (!isNaN(unPdr) && !isNaN(ulTotalPacketCnt)) {
                updateGraph1(ulTotalPacketCnt, unPdr);
            } else {
                console.error('Invalid data points for Graph1.');
            }

            if (!isNaN(ulLatencyL1) && !isNaN(ulTotalPacketCnt)) {
                updateGraph2(ulTotalPacketCnt, ulLatencyL1 / 100);
            } else {
                console.error('Invalid data points for Graph2.');
            }
        }

        fetchAndUpdateGraph();
        setInterval(fetchAndUpdateGraph, 100);

        function updateGraph1(xValue, unPdrValue) {
            if (!Array.isArray(xValue)) {
                xValue = [xValue];
            }
            if (!Array.isArray(unPdrValue)) {
                unPdrValue = [unPdrValue];
            }

            if (!isNaN(xValue[0]) && !isNaN(unPdrValue[0])) {
                Plotly.extendTraces('graph1', {
                    x: [xValue],
                    y: [unPdrValue]
                }, [0]);

                // TotalPacketCount 텍스트 추가
                let totalPacketCount = xValue[0];
                let middleYValue = (80 + 100) / 2;

                Plotly.relayout('graph1', {
                    yaxis: { range: [80, 100], title: 'PDR (Packet Delivery Rate) (%)', dtick: 1 },
                    xaxis: { title: 'The Total Received Rx Packets' },
                    annotations: [
                        {
                            x: totalPacketCount,
                            y: middleYValue,
                            xref: 'x',
                            yref: 'y',
                            text: `Received Total Tx Packets: ${s_unSeqNum}<br>Received Total Rx Packets: ${totalPacketCount}`,
                            showarrow: false,
                            font: {
                                family: 'Arial, sans-serif',
                                size: 16,
                                color: 'black',
                                weight: 'bold'
                            },
                            align: 'center',
                            bordercolor: 'black',
                            borderwidth: 1,
                            borderpad: 4,
                            bgcolor: '#ffffff',
                            opacity: 0.8
                        }
                    ]
                });

                document.getElementById('pdr-value').innerText = `PDR(Packet Delivery Rate) ${unPdrValue[0]}%`;
            } else {
                console.error('Invalid data points for Graph1.');
            }
        }

        let latencyData = [];

        function updateGraph2(xValue, ulLatencyValue) {
            if (!Array.isArray(xValue)) {
                xValue = [xValue];
            }
            if (!Array.isArray(ulLatencyValue)) {
                ulLatencyValue = [ulLatencyValue];
            }

            if (!isNaN(xValue[0]) && !isNaN(ulLatencyValue[0])) {
                latencyData.push({x: xValue[0], y: ulLatencyValue[0]});

                Plotly.update('graph2', {
                    x: [latencyData.map(point => point.x)],
                    y: [latencyData.map(point => point.y)]
                }, [0]);

                let avgLatency = latencyData.reduce((sum, point) => sum + point.y, 0) / latencyData.length;

                Plotly.relayout('graph2', {
                    yaxis: { range: [0, 15], title: 'Latency (ms)', dtick: 1 },
                    xaxis: { title: 'The Total Received Rx Packets' },
                    shapes: [
                        {
                            type: 'line',
                            x0: latencyData[0].x, x1: latencyData[latencyData.length - 1].x,
                            y0: avgLatency, y1: avgLatency,
                            line: {
                                color: 'red',
                                width: 2,
                                dash: 'dash'
                            }
                        }
                    ],
                    annotations: [
                        {
                            x: latencyData[latencyData.length - 1].x,
                            y: avgLatency,
                            xref: 'x',
                            yref: 'y',
                            text: `Avg: ${avgLatency.toFixed(2)} ms`,
                            showarrow: false,
                            font: {
                                family: 'Arial, sans-serif',
                                size: 16,
                                color: 'red',
                            },
                            align: 'right',
                            xanchor: 'left',
                            yanchor: 'bottom',
                            bordercolor: 'red',
                            borderwidth: 2,
                            borderpad: 4,
                            bgcolor: '#ffffff',
                            opacity: 0.8
                        }
                    ]
                });

                document.getElementById('latency-value').innerText = `Latency(Air to Air) ${ulLatencyValue[0]}ms, Avg: ${avgLatency.toFixed(2)}ms`;
            } else {
                console.error('Invalid data points for Graph2.');
            }
        }
        Plotly.newPlot('graph1', [{
            x: [],
            y: [],
            type: 'scatter',
            mode: 'lines+markers',
            line: { color: 'green', width: 2 },
            marker: { color: 'green', size: 6 }
        }], {
            margin: { t: 60, b: 40, l: 50, r: 30 }, // 타이틀 높이에 맞게 top margin 증가
            yaxis: { range: [80, 100], title: 'PDR (%)', showgrid: true, zeroline: true, dtick: 1 },
            xaxis: { title: 'ulTotalPacketCnt', showgrid: true },
            title: {
                text: 'Real-time PDR Monitoring',
                font: {
                    size: 24,  // 타이틀 글자 크기만 설정
                    color: 'white'
                },
                x: 0.5,  // 중앙 정렬
                xanchor: 'center',
                yanchor: 'top'
            },
            plot_bgcolor: 'rgba(0, 0, 0, 0.7)',  // 그래프 내부 배경
            paper_bgcolor: 'rgba(0, 0, 0, 0.7)', // 그래프 전체 배경
            font: {
                color: 'white'
            },
            xaxis: {
                gridcolor: 'rgba(255, 255, 255, 0.3)',
            },
            yaxis: {
                gridcolor: 'rgba(255, 255, 255, 0.3)',
            }
        });

        Plotly.newPlot('graph2', [{
            x: [],
            y: [],
            type: 'scatter',
            mode: 'lines+markers',
            line: { color: 'blue', width: 2 },
            marker: { color: 'blue', size: 6 }
        }], {
            margin: { t: 60, b: 40, l: 50, r: 30 }, // 타이틀 높이에 맞게 top margin 증가
            yaxis: { range: [0, 15], title: 'Latency (ms)', showgrid: true, zeroline: true, dtick: 1 },
            xaxis: { title: 'ulTotalPacketCnt', showgrid: true },
            title: {
                text: 'Real-time Latency Monitoring',
                font: {
                    size: 24,  // 타이틀 글자 크기만 설정
                    color: 'white'
                },
                x: 0.5,  // 중앙 정렬
                xanchor: 'center',
                yanchor: 'top'
            },
            plot_bgcolor: 'rgba(0, 0, 0, 0.7)',  // 그래프 내부 배경
            paper_bgcolor: 'rgba(0, 0, 0, 0.7)', // 그래프 전체 배경
            font: {
                color: 'white'
            },
            xaxis: {
                gridcolor: 'rgba(255, 255, 255, 0.3)',
            },
            yaxis: {
                gridcolor: 'rgba(255, 255, 255, 0.3)',
            }
        });

        const weatherApiKey = '0384422edd4701383345e4e16d05b903';

        function updateWeather() {
            const center = map.getCenter();
            const lat = center.lat;
            const lon = center.lng;

            fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&appid=${weatherApiKey}`)
                .then(response => response.json())
                .then(data => {
                    console.log(data); // API 응답 데이터를 콘솔에 출력하여 확인

                    if (data.cod === 200) {
                        const icon = data.weather[0].icon;
                        const temp = data.main.temp;
                        const humidity = data.main.humidity;
                        const location = data.name;

                        document.getElementById('weather-icon').src = `https://openweathermap.org/img/wn/${icon}.png`;
                        document.getElementById('location').textContent = `Location: ${location}`;
                        document.getElementById('temperature').textContent = `Temperature: ${temp.toFixed(1)}°C`;
                        document.getElementById('humidity').textContent = `Humidity: ${humidity}%`;
                    } else {
                        console.error(`Error: ${data.message}`);
                        document.getElementById('weather-icon').src = '';
                        document.getElementById('location').textContent = 'Location: Data not available';
                        document.getElementById('temperature').textContent = 'Temperature: Data not available';
                        document.getElementById('humidity').textContent = 'Humidity: Data not available';
                    }
                })
                .catch(error => {
                    console.error('Error fetching weather data:', error);
                    document.getElementById('weather-icon').src = '';
                    document.getElementById('location').textContent = 'Location: Error fetching data';
                    document.getElementById('temperature').textContent = 'Temperature: Error fetching data';
                    document.getElementById('humidity').textContent = 'Humidity: Error fetching data';
                });
        }

        updateWeather();
        setInterval(updateWeather, 600000);


        updateWeather();
        setInterval(updateWeather, 600000);
    }
};

</script>
</body>
</html>