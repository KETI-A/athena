<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Guides</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v3.5.1/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.5.1/mapbox-gl.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
#map { position: absolute; top: 0; bottom: 0; width: 75%; }
#graphs { position: absolute; top: 0; bottom: 0; right: 0; width: 25%; display: flex; flex-direction: column; }
.graph { flex: 1; }
</style>
</head>
<body>
<div id="map"></div>
<div id="graphs">
    <div id="graph1" class="graph"></div>
    <div id="graph2" class="graph"></div>
</div>
<script>
    // KETI Pangyo
    const cKetiPangyoLatitude = 37.4064;
    const cKetiPangyolongitude = 127.1021;

    // RSU Location
    const cPangyoRsuLatitude16 = 37.409221;
    const cPangyoRsuLongitude16 = 127.099505;

    const cPangyoRsuLatitude17 = 37.406536;
    const cPangyoRsuLongitude17 = 127.100765;

    const cPangyoRsuLatitude18 = 37.405254;
    const cPangyoRsuLongitude18 = 127.103609;

    const cPangyoRsuLatitude5 = 37.410922;
    const cPangyoRsuLongitude5 = 127.094732;

    const cPangyoRsuLatitude31 = 37.411751;
    const cPangyoRsuLongitude31 = 127.095019;

    // Vehicle Default Location
    var vehicleLatitude0 = 37.4062;
    var vehicleLongitude0 = 127.1032;

    var vehicleLatitude1 = 37.4058;
    var vehicleLongitude1 = 127.1035;

    var vehicleHeading0 = 320;
    var vehicleHeading1 = 320;

	mapboxgl.accessToken = 'pk.eyJ1IjoieWVzYm1hbiIsImEiOiJjbHoxNHVydHQyNzBzMmpzMHNobGUxNnZ6In0.bAFH10On30d_Cj-zTMi53Q';
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/yesbman/clyzkeh8900dr01pxdqow8awk',
        projection: 'globe',
        zoom: 18,
        center: [cKetiPangyolongitude, cKetiPangyoLatitude]
    });

    map.addControl(new mapboxgl.NavigationControl());

    map.on('style.load', () => {
        map.setFog({});
    });

    map.on('load', () => {
        map.loadImage(
            'https://raw.githubusercontent.com/KETI-A/athena/main/src/apps/html/images/keti_ci.png',
            (error, image) => {
                if (error) throw error;

                map.addImage('keti-log', image);

                map.addSource('keti_log_src', {
                    'type': 'geojson',
                    'data': {
                        'type': 'FeatureCollection',
                        'features': [
                            {
                                'type': 'Feature',
                                'geometry': {
                                    'type': 'Point',
                                    'coordinates': [cKetiPangyolongitude, cKetiPangyoLatitude]
                                }
                            }
                        ]
                    }
                });

                map.addLayer({
                    'id': 'keti',
                    'type': 'symbol',
                    'source': 'keti_log_src',
                    'layout': {
                        'icon-image': 'keti-log',
                        'icon-size': 0.50
                    }
                });
            }
        );

        map.loadImage(
            'https://raw.githubusercontent.com/KETI-A/athena/main/src/apps/html/images/v2x-rsu.png',
            (error, image) => {
                if (error) throw error;

                map.addImage('rsu', image);

                map.addSource('rsu-src-18', {
                    'type': 'geojson',
                    'data': {
                        'type': 'FeatureCollection',
                        'features': [
                            {
                                'type': 'Feature',
                                'geometry': {
                                    'type': 'Point',
                                    'coordinates': [cPangyoRsuLongitude18, cPangyoRsuLatitude18]
                                }
                            }
                        ]
                    }
                });

                map.addLayer({
                    'id': 'rsu18',
                    'type': 'symbol',
                    'source': 'rsu-src-18',
                    'layout': {
                        'icon-image': 'rsu',
                        'icon-size': 0.15
                    }
                });

                map.addSource('rsu-src-16', {
                    'type': 'geojson',
                    'data': {
                        'type': 'FeatureCollection',
                        'features': [
                            {
                                'type': 'Feature',
                                'geometry': {
                                    'type': 'Point',
                                    'coordinates': [cPangyoRsuLongitude16, cPangyoRsuLatitude16]
                                }
                            }
                        ]
                    }
                });

                map.addLayer({
                    'id': 'rsu16',
                    'type': 'symbol',
                    'source': 'rsu-src-16',
                    'layout': {
                        'icon-image': 'rsu',
                        'icon-size': 0.15
                    }
                });

                map.addSource('rsu-src-17', {
                    'type': 'geojson',
                    'data': {
                        'type': 'FeatureCollection',
                        'features': [
                            {
                                'type': 'Feature',
                                'geometry': {
                                    'type': 'Point',
                                    'coordinates': [cPangyoRsuLongitude17, cPangyoRsuLatitude17]
                                }
                            }
                        ]
                    }
                });

                map.addLayer({
                    'id': 'rsu17',
                    'type': 'symbol',
                    'source': 'rsu-src-17',
                    'layout': {
                        'icon-image': 'rsu',
                        'icon-size': 0.15
                    }
                });

            }
        );

        map.addSource('rsu-src-31', {
            'type': 'geojson',
            'data': {
                'type': 'FeatureCollection',
                'features': [
                    {
                        'type': 'Feature',
                        'geometry': {
                            'type': 'Point',
                            'coordinates': [cPangyoRsuLongitude31, cPangyoRsuLatitude31]
                        }
                    }
                ]
            }
        });

        map.addLayer({
            'id': 'rsu31',
            'type': 'symbol',
            'source': 'rsu-src-31',
            'layout': {
                'icon-image': 'rsu',
                'icon-size': 0.15
            }
        });

        map.addSource('rsu-src-5', {
            'type': 'geojson',
            'data': {
                'type': 'FeatureCollection',
                'features': [
                    {
                        'type': 'Feature',
                        'geometry': {
                            'type': 'Point',
                            'coordinates': [cPangyoRsuLongitude5, cPangyoRsuLatitude5]
                        }
                    }
                ]
            }
        });

        map.addLayer({
            'id': 'rsu5',
            'type': 'symbol',
            'source': 'rsu-src-5',
            'layout': {
                'icon-image': 'rsu',
                'icon-size': 0.15
            }
        });
    });

    map.loadImage(
        'https://raw.githubusercontent.com/KETI-A/athena/main/src/apps/html/images/vehicle.png',
        (error, image) => {
            if (error) throw error;

            map.addImage('vehicle', image);

            map.addSource('vehicle_src_0', {
                'type': 'geojson',
                'data': {
                    'type': 'FeatureCollection',
                    'features': [
                        {
                            'type': 'Feature',
                            'geometry': {
                                'type': 'Point',
                                'coordinates': [vehicleLongitude0, vehicleLatitude0]
                            }
                        }
                    ]
                }
            });

            map.addSource('vehicle_src_1', {
                'type': 'geojson',
                'data': {
                    'type': 'FeatureCollection',
                    'features': [
                        {
                            'type': 'Feature',
                            'geometry': {
                                'type': 'Point',
                                'coordinates': [vehicleLongitude1, vehicleLatitude1]
                            }
                        }
                    ]
                }
            });

            map.addSource('line', {
                'type': 'geojson',
                'data': {
                    'type': 'Feature',
                    'geometry': {
                        'type': 'LineString',
                        'coordinates': [[vehicleLongitude0, vehicleLatitude0], [vehicleLongitude1, vehicleLatitude1]]
                    }
                }
            });

            map.addLayer({
                'id': 'lineLayer',
                'type': 'line',
                'source': 'line',
                'layout': {},
                'paint': {
                    'line-color': [
                        'interpolate',
                        ['linear'],
                        ['line-progress'],
                        0, '#00FFFF',
                        1, '#008B8B'
                    ],
                    'line-width': 1.5
                }
            });

            map.addLayer({
                'id': 'lineLabelLayer',
                'type': 'symbol',
                'source': 'line',
                'layout': {
                    'symbol-placement': 'line',
                    'text-field': 'Connected V2X',
                    'text-font': ['Open Sans Regular', 'Arial Unicode MS Regular'],
                    'text-size': 12,
                    'text-anchor': 'center'
                },
                'paint': {
                    'text-color': '#000000',
                    'text-halo-color': '#FFFFFF',
                    'text-halo-width': 2
                }
            });

            map.addLayer({
                'id': 'vehicle0',
                'type': 'symbol',
                'source': 'vehicle_src_0',
                'layout': {
                    'icon-image': 'vehicle',
                    'icon-size': 0.03,
                    'icon-rotate': ['get', 'heading'],
                    'text-field': ['concat', 'Heading ', ['get', 'heading']],
                    'text-font': ['Open Sans Semibold', 'Arial Unicode MS Bold'],
                    'text-offset': [0, 1.25], // Adjust this value to position the text
                    'text-anchor': 'top'
                },
                'paint': {
                    'text-color': '#000000',
                    'text-halo-color': '#FFFFFF',
                    'text-halo-width': 2
                }
            });

            map.addLayer({
                'id': 'vehicle1',
                'type': 'symbol',
                'source': 'vehicle_src_1',
                'layout': {
                    'icon-image': 'vehicle',
                    'icon-size': 0.03,
                    'icon-rotate': ['get', 'heading'],
                    'text-field': ['concat', 'Heading ', ['get', 'heading']],
                    'text-font': ['Open Sans Semibold', 'Arial Unicode MS Bold'],
                    'text-offset': [0, 1.25], // Adjust this value to position the text
                    'text-anchor': 'top'
                },
                'paint': {
                    'text-color': '#000000',
                    'text-halo-color': '#FFFFFF',
                    'text-halo-width': 2
                }
            });

            function updateVehiclePosition(vehicleId, coordinates, heading) {
                map.getSource(`vehicle_src_${vehicleId}`).setData({
                    'type': 'FeatureCollection',
                    'features': [{
                        'type': 'Feature',
                        'geometry': {
                            'type': 'Point',
                            'coordinates': coordinates
                        },
                        'properties': {
                            'heading': heading
                        }
                    }]
                });

                if (vehicleId === 0) {
                    vehicleLongitude0 = coordinates[0];
                    vehicleLatitude0 = coordinates[1];
                } else if (vehicleId === 1) {
                    vehicleLongitude1 = coordinates[0];
                    vehicleLatitude1 = coordinates[1];
                }

                map.getSource('line').setData({
                    'type': 'Feature',
                    'geometry': {
                        'type': 'LineString',
                        'coordinates': [[vehicleLongitude0, vehicleLatitude0], [vehicleLongitude1, vehicleLatitude1]]
                    }
                });

                if (vehicleId === 0) {
                    map.setCenter(coordinates);
                }
            }

            let currentRowIndex = 1; /* 2nd lines */
            function fetchAndUpdate() {
                //fetch('https://raw.githubusercontent.com/KETI-A/athena/main/src/apps/qt/venus/db/rx_db_sample_1.csv')
                fetch('http://10.252.110.58/rx_db_sample_1.csv')
                //fetch('z:/rx_db_sample_1.csv')
                //fetch('http://localhost/rx_db_sample_1.csv')
                    .then(response => response.text())
                    .then(csvText => {
                        Papa.parse(csvText, {
                            header: true,
                            skipEmptyLines: true,
                            complete: function(results) {
                                const rows = results.data;
                                if (currentRowIndex < rows.length) {
                                    const row = rows[currentRowIndex];
                                    const latitude0 = parseFloat(row['nRxLatitude']);
                                    const longitude0 = parseFloat(row['nRxLongitude']);
                                    const heading0 = parseFloat(row['unRxVehicleHeading']);
                                    const latitude1 = parseFloat(row['nTxLatitude']);
                                    const longitude1 = parseFloat(row['nTxLongitude']);
                                    const heading1 = parseFloat(row['unTxVehicleHeading']);
                                    const unPdr = parseFloat(row['unPdr(percent)']);
                                    const ulLatencyL1 = parseFloat(row['ulLatencyL1(us)']);
                                    const ulTotalPacketCnt = parseFloat(row['ulTotalPacketCnt']);

                                    if (!isNaN(latitude0) && !isNaN(longitude0)) {
                                        //console.log(`Vehicle 0 - Row ${currentRowIndex + 1}, Latitude: ${latitude0}, Longitude: ${longitude0}, Heading: ${heading0}`);
                                        updateVehiclePosition(0, [longitude0, latitude0], heading0);
                                    }

                                    if (!isNaN(latitude1) && !isNaN(longitude1)) {
                                        //console.log(`Vehicle 1 - Row ${currentRowIndex + 1}, Latitude: ${latitude1}, Longitude: ${longitude1}, Heading: ${heading1}`);
                                        updateVehiclePosition(1, [longitude1, latitude1], heading1);
                                    }

                                    updateGraph1(ulTotalPacketCnt, unPdr);
                                    updateGraph2(ulTotalPacketCnt, ulLatencyL1 / 100);
                                    //console.log("ulTotalPacketCnt:", ulTotalPacketCnt);

                                    currentRowIndex++;
                                } else {
                                    console.log('Waiting for new data...');
                                }
                            }
                        });
                    })
                    .catch(error => console.error('Error fetching the CSV file:', error));
            }

            fetchAndUpdate();
            setInterval(fetchAndUpdate, 100);

            function updateGraph1(xValue, unPdrValue) {
                Plotly.extendTraces('graph1', {
                    x: [[xValue]],
                    y: [[unPdrValue]]
                }, [0]);

                Plotly.relayout('graph1', {
                    yaxis: { range: [80, 100], title: 'unPdr (%)', dtick: 1 },
                    xaxis: { title: 'ulTotalPacketCnt' }
                });
            }

            Plotly.newPlot('graph1', [{
                x: [],
                y: [],
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: 'green', width: 2 },
                marker: { color: 'green', size: 6 }
            }], {
                margin: { t: 50, b: 40, l: 50, r: 30 },
                yaxis: { range: [80, 100], title: 'PDR (%)', showgrid: true, zeroline: true, dtick: 1 },
                xaxis: { title: 'ulTotalPacketCnt', showgrid: true },
                title: 'Real-time PDR Monitoring',
                plot_bgcolor: '#f0f0f0',
                paper_bgcolor: '#ffffff'
            });

            function updateGraph2(xValue, ulLatencyValue) {
                Plotly.extendTraces('graph2', {
                    x: [[xValue]],
                    y: [[ulLatencyValue]]
                }, [0]);

                Plotly.relayout('graph2', {
                    yaxis: { range: [0, 15], title: 'Latency (ms)', dtick: 1 },
                    xaxis: { title: 'ulTotalPacketCnt' }
                });
            }

            Plotly.newPlot('graph2', [{
                x: [],
                y: [],
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: 'blue', width: 2 },
                marker: { color: 'blue', size: 6 }
            }], {
                margin: { t: 50, b: 40, l: 50, r: 30 },
                yaxis: { range: [0, 15], title: 'Modem Latency (Air to Air)', showgrid: true, zeroline: true, dtick: 1 },
                xaxis: { title: 'ulTotalPacketCnt', showgrid: true },
                title: 'Real-time Latency Monitoring',
                plot_bgcolor: '#f0f0f0',
                paper_bgcolor: '#ffffff'
            });
        }
    );
</script>
</body>
</html>